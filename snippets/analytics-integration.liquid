{% comment %}
  Analytics Integration Helper
  Supports multiple analytics platforms
{% endcomment %}

{%- if settings.google_analytics_id != blank or settings.ga4_measurement_id != blank or settings.facebook_pixel_id != blank or settings.gtm_container_id != blank -%}

<!-- Google Tag Manager -->
{%- if settings.gtm_container_id != blank -%}
<script>
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','{{ settings.gtm_container_id }}');
</script>
{%- endif -%}

<!-- Global Analytics Object -->
<script>
  window.analytics = window.analytics || {
    page: function() {},
    track: function() {},
    identify: function() {}
  };

  // Enhanced Ecommerce Data Layer
  window.dataLayer = window.dataLayer || [];

  // Shop Data
  window.analytics.shop = {
    currency: {{ shop.currency | json }},
    country: {{ shop.address.country_code | json }},
    name: {{ shop.name | json }},
    domain: {{ shop.domain | json }}
  };

  // Customer Data (if logged in)
  {%- if customer -%}
  window.analytics.customer = {
    id: {{ customer.id | json }},
    email: {{ customer.email | json }},
    firstName: {{ customer.first_name | json }},
    lastName: {{ customer.last_name | json }},
    orderCount: {{ customer.orders_count | json }},
    totalSpent: {{ customer.total_spent | money_without_currency | json }},
    tags: {{ customer.tags | json }},
    acceptsMarketing: {{ customer.accepts_marketing | json }}
  };

  // Identify customer
  window.analytics.identify({{ customer.id | json }}, {
    email: {{ customer.email | json }},
    name: {{ customer.name | json }},
    orders_count: {{ customer.orders_count | json }},
    total_spent: {{ customer.total_spent | money_without_currency | json }}
  });
  {%- endif -%}

  // Page View Data
  window.analytics.pageview = {
    pageType: {{ request.page_type | json }},
    url: {{ canonical_url | json }},
    title: {{ page_title | json }},
    path: {{ request.path | json }}
  };
</script>

<!-- Google Analytics 4 -->
{%- if settings.ga4_measurement_id != blank -%}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ settings.ga4_measurement_id }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ settings.ga4_measurement_id }}', {
    'currency': {{ shop.currency | json }},
    'country': {{ shop.address.country_code | json }},
    {%- if customer -%}
    'user_id': {{ customer.id | json }},
    {%- endif -%}
    'page_type': {{ request.page_type | json }}
  });

  // Enhanced Ecommerce Events
  {%- if request.page_type == 'product' -%}
  gtag('event', 'view_item', {
    'currency': {{ shop.currency | json }},
    'value': {{ product.price | divided_by: 100.0 }},
    'items': [{
      'item_id': {{ product.id | json }},
      'item_name': {{ product.title | json }},
      'item_category': {{ product.type | json }},
      'item_variant': {{ product.selected_or_first_available_variant.title | json }},
      'price': {{ product.price | divided_by: 100.0 }},
      'currency': {{ shop.currency | json }}
    }]
  });
  {%- elsif request.page_type == 'collection' -%}
  gtag('event', 'view_item_list', {
    'item_list_id': {{ collection.id | json }},
    'item_list_name': {{ collection.title | json }},
    'items': [
      {%- for product in collection.products limit: 10 -%}
      {
        'item_id': {{ product.id | json }},
        'item_name': {{ product.title | json }},
        'item_category': {{ product.type | json }},
        'price': {{ product.price | divided_by: 100.0 }},
        'currency': {{ shop.currency | json }},
        'index': {{ forloop.index }}
      }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  });
  {%- elsif request.page_type == 'cart' -%}
  gtag('event', 'view_cart', {
    'currency': {{ shop.currency | json }},
    'value': {{ cart.total_price | divided_by: 100.0 }},
    'items': [
      {%- for item in cart.items -%}
      {
        'item_id': {{ item.product_id | json }},
        'item_name': {{ item.product.title | json }},
        'item_variant': {{ item.variant.title | json }},
        'quantity': {{ item.quantity }},
        'price': {{ item.price | divided_by: 100.0 }},
        'currency': {{ shop.currency | json }}
      }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  });
  {%- elsif request.page_type == 'search' -%}
  gtag('event', 'search', {
    'search_term': {{ search.terms | json }}
  });
  {%- endif -%}
</script>
{%- endif -%}

<!-- Facebook Pixel -->
{%- if settings.facebook_pixel_id != blank -%}
<script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  fbq('init', '{{ settings.facebook_pixel_id }}');
  fbq('track', 'PageView');

  {%- if customer -%}
  fbq('track', 'identify', {
    em: {{ customer.email | json }},
    fn: {{ customer.first_name | json }},
    ln: {{ customer.last_name | json }}
  });
  {%- endif -%}

  {%- if request.page_type == 'product' -%}
  fbq('track', 'ViewContent', {
    content_ids: [{{ product.id | json }}],
    content_name: {{ product.title | json }},
    content_type: 'product',
    value: {{ product.price | money_without_currency }},
    currency: {{ shop.currency | json }}
  });
  {%- elsif request.page_type == 'collection' -%}
  fbq('track', 'ViewCategory', {
    content_category: {{ collection.title | json }},
    content_ids: [
      {%- for product in collection.products limit: 10 -%}
        {{ product.id | json }}{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  });
  {%- elsif request.page_type == 'cart' -%}
  fbq('track', 'AddToCart', {
    content_ids: [
      {%- for item in cart.items -%}
        {{ item.product_id | json }}{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ],
    content_type: 'product',
    value: {{ cart.total_price | money_without_currency }},
    currency: {{ shop.currency | json }}
  });
  {%- elsif request.page_type == 'search' -%}
  fbq('track', 'Search', {
    search_string: {{ search.terms | json }}
  });
  {%- endif -%}
</script>
<noscript>
  <img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id={{ settings.facebook_pixel_id }}&ev=PageView&noscript=1"/>
</noscript>
{%- endif -%}

<!-- Pinterest Tag -->
{%- if settings.pinterest_tag_id != blank -%}
<script>
  !function(e){if(!window.pintrk){window.pintrk = function () {
  window.pintrk.queue.push(Array.prototype.slice.call(arguments))};var
    n=window.pintrk;n.queue=[],n.version="3.0";var
    t=document.createElement("script");t.async=!0,t.src=e;var
    r=document.getElementsByTagName("script")[0];
    r.parentNode.insertBefore(t,r)}}("https://s.pinimg.com/ct/core.js");
  pintrk('load', '{{ settings.pinterest_tag_id }}');
  pintrk('page');

  {%- if request.page_type == 'product' -%}
  pintrk('track', 'pagevisit', {
    line_items: [{
      product_id: {{ product.id | json }},
      product_name: {{ product.title | json }},
      product_price: {{ product.price | money_without_currency }},
      product_category: {{ product.type | json }}
    }]
  });
  {%- endif -%}
</script>
<noscript>
  <img height="1" width="1" style="display:none;" alt="" src="https://ct.pinterest.com/v3/?event=init&tid={{ settings.pinterest_tag_id }}&noscript=1" />
</noscript>
{%- endif -%}

<!-- TikTok Pixel -->
{%- if settings.tiktok_pixel_id != blank -%}
<script>
  !function (w, d, t) {
    w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var i="https://analytics.tiktok.com/i18n/pixel/events.js";ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=i,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};var o=document.createElement("script");o.type="text/javascript",o.async=!0,o.src=i+"?sdkid="+e+"&lib="+t;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)};
    ttq.load('{{ settings.tiktok_pixel_id }}');
    ttq.page();
  }(window, document, 'ttq');

  {%- if request.page_type == 'product' -%}
  ttq.track('ViewContent', {
    content_id: {{ product.id | json }},
    content_name: {{ product.title | json }},
    content_category: {{ product.type | json }},
    value: {{ product.price | divided_by: 100.0 }},
    currency: {{ shop.currency | json }}
  });
  {%- endif -%}
</script>
{%- endif -%}

<!-- Custom Event Tracking -->
<script>
  // Universal tracking function
  window.trackEvent = function(eventName, eventData) {
    // Google Analytics 4
    if (typeof gtag !== 'undefined') {
      gtag('event', eventName, eventData);
    }

    // Facebook Pixel
    if (typeof fbq !== 'undefined') {
      fbq('track', eventName, eventData);
    }

    // Pinterest
    if (typeof pintrk !== 'undefined') {
      pintrk('track', eventName, eventData);
    }

    // TikTok
    if (typeof ttq !== 'undefined') {
      ttq.track(eventName, eventData);
    }

    // Custom analytics
    if (window.analytics && window.analytics.track) {
      window.analytics.track(eventName, eventData);
    }

    // Console log in development
    if (window.location.hostname === 'localhost' || window.location.hostname.includes('.myshopify.com')) {
      console.log('Track Event:', eventName, eventData);
    }
  };
</script>

{%- endif -%}