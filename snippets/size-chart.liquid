{% comment %}
  Size Chart Snippet
  Displays product size guide

  Usage:
  {% render 'size-chart', product: product %}
{% endcomment %}

{%- liquid
  assign has_size_chart = false
  assign size_chart_type = product.metafields.custom.size_chart_type | default: settings.default_size_chart_type

  if product.metafields.custom.size_chart != blank
    assign has_size_chart = true
    assign size_chart = product.metafields.custom.size_chart
  elsif product.type != blank and settings[product.type | handleize | append: '_size_chart'] != blank
    assign has_size_chart = true
    assign size_chart = settings[product.type | handleize | append: '_size_chart']
  elsif settings.default_size_chart != blank
    assign has_size_chart = true
    assign size_chart = settings.default_size_chart
  endif
-%}

{%- if has_size_chart -%}
<div class="size-chart" data-size-chart>
  <button type="button"
          class="size-chart__trigger"
          aria-controls="size-chart-modal"
          aria-expanded="false"
          data-size-chart-trigger>
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M3 7h14M3 13h14M7 3v14M13 3v14"/>
    </svg>
    <span>{{ 'products.product.size_guide' | t }}</span>
  </button>

  <div class="size-chart__modal"
       id="size-chart-modal"
       aria-hidden="true"
       data-size-chart-modal>
    <div class="size-chart__overlay" data-size-chart-close></div>
    <div class="size-chart__content">
      <button type="button"
              class="size-chart__close"
              aria-label="{{ 'general.accessibility.close' | t }}"
              data-size-chart-close>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>

      <h2 class="size-chart__title">{{ 'products.product.size_guide' | t }}</h2>

      {%- if size_chart_type == 'table' -%}
        <div class="size-chart__table-wrapper">
          {{ size_chart }}
        </div>
      {%- elsif size_chart_type == 'image' -%}
        <div class="size-chart__image">
          <img src="{{ size_chart | image_url }}"
               alt="{{ 'products.product.size_guide' | t }}"
               loading="lazy">
        </div>
      {%- else -%}
        <div class="size-chart__content-wrapper">
          {{ size_chart }}
        </div>
      {%- endif -%}

      <div class="size-chart__measurement-guide">
        <h3>{{ 'products.size_chart.how_to_measure' | t }}</h3>
        <ol class="size-chart__steps">
          <li>{{ 'products.size_chart.step_1' | t | default: 'Stand straight with arms at your side' }}</li>
          <li>{{ 'products.size_chart.step_2' | t | default: 'Measure around the fullest part of your chest' }}</li>
          <li>{{ 'products.size_chart.step_3' | t | default: 'Measure around your natural waistline' }}</li>
          <li>{{ 'products.size_chart.step_4' | t | default: 'Measure around the fullest part of your hips' }}</li>
        </ol>
      </div>

      <div class="size-chart__conversion">
        <h3>{{ 'products.size_chart.conversion' | t }}</h3>
        <div class="size-chart__toggle">
          <button type="button"
                  class="size-chart__unit active"
                  data-unit="cm">CM</button>
          <button type="button"
                  class="size-chart__unit"
                  data-unit="inch">INCH</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .size-chart__trigger {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.3s ease;
  }

  .size-chart__trigger:hover {
    background: var(--color-background-secondary);
    border-color: var(--color-text);
  }

  .size-chart__modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
  }

  .size-chart__modal[aria-hidden="false"] {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .size-chart__overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .size-chart__content {
    position: relative;
    background: white;
    border-radius: 8px;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 2rem;
    margin: 1rem;
  }

  .size-chart__close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .size-chart__close:hover {
    transform: rotate(90deg);
  }

  .size-chart__title {
    font-size: 1.5rem;
    margin-bottom: 2rem;
    text-align: center;
  }

  .size-chart__table-wrapper {
    overflow-x: auto;
    margin-bottom: 2rem;
  }

  .size-chart__table-wrapper table {
    width: 100%;
    border-collapse: collapse;
  }

  .size-chart__table-wrapper th,
  .size-chart__table-wrapper td {
    padding: 0.75rem;
    text-align: center;
    border: 1px solid var(--color-border);
  }

  .size-chart__table-wrapper th {
    background: var(--color-background-secondary);
    font-weight: 600;
  }

  .size-chart__measurement-guide {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .size-chart__measurement-guide h3 {
    font-size: 1.125rem;
    margin-bottom: 1rem;
  }

  .size-chart__steps {
    margin-left: 1.5rem;
    line-height: 1.8;
  }

  .size-chart__conversion {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .size-chart__toggle {
    display: flex;
    gap: 0.5rem;
  }

  .size-chart__unit {
    padding: 0.5rem 1rem;
    background: transparent;
    border: 1px solid var(--color-border);
    cursor: pointer;
    transition: all 0.3s;
  }

  .size-chart__unit.active {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }

  @media (max-width: 768px) {
    .size-chart__content {
      padding: 1.5rem 1rem;
    }

    .size-chart__table-wrapper {
      font-size: 0.875rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sizeChart = document.querySelector('[data-size-chart]');
    if (!sizeChart) return;

    const trigger = sizeChart.querySelector('[data-size-chart-trigger]');
    const modal = sizeChart.querySelector('[data-size-chart-modal]');
    const closeButtons = sizeChart.querySelectorAll('[data-size-chart-close]');
    const unitButtons = sizeChart.querySelectorAll('[data-unit]');

    // Open modal
    trigger.addEventListener('click', function() {
      modal.setAttribute('aria-hidden', 'false');
      trigger.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
    });

    // Close modal
    closeButtons.forEach(button => {
      button.addEventListener('click', function() {
        modal.setAttribute('aria-hidden', 'true');
        trigger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      });
    });

    // Unit conversion
    unitButtons.forEach(button => {
      button.addEventListener('click', function() {
        unitButtons.forEach(b => b.classList.remove('active'));
        button.classList.add('active');

        const unit = button.dataset.unit;
        const tables = sizeChart.querySelectorAll('table');

        tables.forEach(table => {
          const cells = table.querySelectorAll('td');
          cells.forEach(cell => {
            const text = cell.textContent;
            const match = text.match(/(\d+\.?\d*)/);

            if (match) {
              const value = parseFloat(match[1]);
              if (unit === 'inch') {
                cell.textContent = text.replace(match[1], (value / 2.54).toFixed(1));
              } else {
                cell.textContent = text.replace(match[1], (value * 2.54).toFixed(0));
              }
            }
          });
        });
      });
    });

    // ESC key to close
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
        modal.setAttribute('aria-hidden', 'true');
        trigger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }
    });
  });
</script>
{%- endif -%}